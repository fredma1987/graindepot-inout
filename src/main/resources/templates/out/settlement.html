<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head th:include="head::head(${title})">
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script  th:inline="javascript">

    </script>
</head>

<body>
<script th:src="@{/assets/js/bootstrap3-typeahead.js}"></script>
<div class="main-container" id="main-container">
    <script th:src="@{../js/huashi.js}"></script>
    <script th:src="@{../js/d8.js}"></script>
    <div th:replace="navbar::navbar"></div>
    <div class="main-container-inner">
        <div class="main-content" id="main-content" style="float: left;margin-left:0px;width:100%">
            <div class="page-content" style="padding:10px 30px 0px">
                <div class="page-header">
                    <h1>
                        销售结算
                        <small>
                            <i class="icon-double-angle-right"></i>

                        </small>
                    </h1>
                </div>
                <!-- /.page-header -->

                <div class="row">
                    <div class="col-xs-12">
                        <!-- PAGE CONTENT BEGINS -->

                        <form class="form-horizontal" role="form">
                            <div class="row">
                                <div class="col-xs-12 col-sm-4" style="border:1px solid #CCC;padding:3px;width:100%">

                                    <div style="width: 100%;height:100%;padding-left:20px;float: left">
                                        <div class="form-group">
                                            <div style="float: left;padding-left: 10px">
                                                <label class="col-sm-4 control-label no-padding-right"
                                                       style="width:70px;padding-left:0px" id="trader"> 购粮单位：</label>
                                                <div class="col-sm-4" style="width:300px;padding-left:0px">
                                                    <select id="traderid" name="traderid" class="form-control">
                                                    </select>
                                                </div>
                                            </div>
                                            <div style="float: left;padding-left: 10px">
                                                <label class="col-sm-4 control-label no-padding-right" style="width:70px;padding-left:0px"> 仓房号： </label>
                                                <div class="col-sm-4" style="width:150px;padding-left:0px">
                                                    <select id="storageid" name="storageid" class="form-control">
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <hr style="margin-bottom:5px;margin-top:15px"/>
                                        <div class="form-group">
                                            <div style="float: left;padding-left: 10px">
                                                <label> 结算金额： </label>
                                                <input type="text" id="sumamt" name="sumamt" style="width:150px"
                                                       placeholder=""/>
                                            </div>
                                            <div style="float: left;padding-left: 10px">
                                                <label class="col-sm-4 control-label no-padding-right" style="width:88px;padding-left:0px"> 结算方式：</label>
                                                <div class="col-sm-4" style="width:150px;padding-left:0px">
                                                    <select id="settleid" name="settleid" class="form-control">
                                                    </select>
                                                </div>
                                            </div>
                                            <div style="float: left;padding-left: 10px">
                                                <label> 票号： </label>
                                                <input type="text" id="checkno" name="checkno" style="width:150px"
                                                       placeholder=""/>
                                            </div>
                                            <div style="float: left;padding-left: 10px">
                                                <label class="col-sm-4 control-label no-padding-right" style="width:80px;padding-left:0px"> 收款账户：</label>
                                                <div class="col-sm-4" style="width:150px;padding-left:0px">
                                                    <select id="accid" name="accid" class="form-control">
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <hr style="margin-bottom:5px;margin-top:15px"/>
                                        <div class="form-group">
                                            <div style="float: left;padding-left: 10px">
                                                <label> 收款金额： </label>
                                                <input type="text" id="accamt" name="accamt" style="width:150px;"
                                                       placeholder=""/>
                                            </div>
                                            <div style="float: left;padding-left: 10px">
                                                <label> 使用预收款： </label>
                                                <input type="text" id="usepreamt" name="usepreamt" style="width:150px"
                                                       placeholder=""/>
                                            </div>
                                            <div style="float: left;padding-left: 10px">
                                                <label> 预收款余额： </label>
                                                <input type="text" id="preamt" name="preamt" style="width:150px"
                                                       placeholder=""/>
                                            </div>
                                        </div>
                                        <hr style="margin-bottom:5px;margin-top:15px"/>
                                        <div class="form-group">
                                            <div style="float: left;padding-left: 0px">
                                                <label class="col-sm-4 control-label no-padding-right"
                                                       style="width:60px;padding-left:0px"> 合同号：</label>
                                                <div class="col-sm-4" style="width:200px;padding-left:0px">
                                                    <select id="contractid" name="contractid" class="form-control">
                                                    </select>
                                                </div>
                                            </div>
                                            <div style="float: left;padding-left: 10px">
                                                <label> 备注： </label>
                                                <input type="text" id="remark" name="remark" style="width:350px"
                                                       placeholder=""/>
                                            </div>
                                        </div>
                                        <hr style="margin-bottom:5px;margin-top:5px"/>
                                    <div class="col-xs-12">
                                        <div  style="margin-top: 4px;margin-bottom: 4px">
                                            <div class="col-sm-4">
                                                <a class="btn btn-sm btn-primary" onclick="toAdd()">
                                                    <i class="icon-plus align-top bigger-125"></i>
                                                    添加到结算
                                                </a>
                                                <a class="btn btn-sm btn-danger" onclick="doDel()">
                                                    <i class="icon-trash align-top bigger-125"></i>
                                                    本次不结算
                                                </a>
                                            </div>
                                        </div>
                                            <div class="col-xs-12">
                                            <div class="table-responsive">
                                                <table id="myTable" style="width:100%" class="table table-striped table-bordered table-hover">
                                                    <thead>
                                                    <tr>
                                                        <th class="center" style="width: 20px"></th>
                                                        <th class="center" style="width: 20px;">
                                                            <label>
                                                                <input id="CK" type="checkbox" class="ace"/>
                                                                <span class="lbl"></span>
                                                            </label>
                                                        </th>
                                                        <th style="width: 200px">出库日期</th>
                                                        <th style="width: 200px">出库流水号</th>
                                                        <th style="width: 100px">车船号</th>
                                                        <th style="width: 100px">仓房号</th>
                                                        <th style="width: 100px">粮食性质</th>
                                                        <th style="width: 100px">粮食品种</th>
                                                        <th style="width: 100px">结算数量</th>
                                                        <th style="width: 100px">结算单价</th>
                                                        <th style="width: 100px">结算金额</th>
                                                        <th style="width: 100px">摘要</th>
                                                    </tr>
                                                    </thead>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- /span -->
                            </div>
                            </div>
                            <div class="row" style="float: right;padding-right: 12px">
                                <a class="btn btn-success" style="border: 0;width: 120px;">
                                    <i class="icon-arrow-left icon-on-left"></i>
                                    前一单
                                </a>
                                <a class="btn btn-success" style="border: 0;width: 120px;">
                                    <i class="icon-arrow-right icon-on-right"></i>
                                    后一单
                                </a>
                                <!--<OBJECT id=rd codeBase="comRD800.cab" WIDTH="10" HEIGHT="0"
                                        classid="clsid:638B238E-EB84-4933-B3C8-854B86140668">
                                </OBJECT>
                                <a class="btn btn-success" style="border: 0;width: 120px;">
                                    <i class="icon-credit-card"></i>
                                    刷卡查单
                                </a>
                                <a class="btn btn-success" style="border: 0;width: 120px;">
                                    <i class="icon-search"></i>
                                    单据查询
                                </a>-->
                                <a class="btn btn-success" style="border: 0;width: 120px;">
                                    <i class="icon-legal"></i>
                                    确认结算
                                </a>
                                <a class="btn btn-success" style="border: 0;width: 120px;padding-left:10px">
                                    <i class="icon-undo"></i>
                                    取消
                                </a>
                            </div>
                        </form>
                    </div>
                    <!-- /.col -->
                </div>
                <!-- /.row -->
            </div>
            <!-- /.page-content -->
        </div>
        <!-- /.main-content -->
    </div>
    <!-- /.main-container-inner -->

</div>
<!-- /.main-container -->

<script  type="text/javascript">
    var param={"inoutflag":-1,"buysellflag":-1};
    var theTable;
    jQuery(function ($) {
        initTrader();
        initStorage();
        comm_initSettle();
        comm_initContract(param);
        comm_initAccount(param);

    });
    function toAdd(){
        var checkedList =$('#myTable').bootstrapTable("getChecked");
        if (checkedList.length==0) {
            $.bootstrapBox.alert.init({message: "请选择本次结算的行"});
            return
        }
        var sumamt=0,accamt=0;
        for(var i=0;i<checkedList.length;i++){
            if(checkedList[i].amount!=null){
                sumamt+=checkedList[i].amount;
                accamt+=checkedList[i].amount;
            }
        }
        $("#sumamt").val(sumamt);
        $("#accamt").val(accamt);
    }
    function doDel() {
        if(theTable==undefined){
            $.bootstrapBox.alert.init({message: "请选择本次不结算的行"});
            return
        }
        var checkedList = $('#myTable').bootstrapTable("getChecked");
        if (checkedList.length==0) {
            $.bootstrapBox.alert.init({message: "请选择本次不结算的行"});
            return
        }

        $.bootstrapBox.confirm.init({
            message: "确认选择的单据本次不结算吗？",
            callback: function (result) {
                if (result) {
                    //删除行
                    var sumamt=$("#sumamt").val();
                    var accamt=$("#accamt").val();
                    for(var i=0;i<checkedList.length;i++){
                        if(checkedList[i].amount!=null){
                            if(sumamt!=null){
                                sumamt-=checkedList[i].amount;
                                accamt-=checkedList[i].amount;
                            }
                        }
                    }
                    $("#sumamt").val(sumamt);
                    $("#accamt").val(accamt);
                    $('#myTable').bootstrapTable("remove");
                    /*$.post("/graindepot-inout/video/del", {ids:ids.join(",")}, function (result) {
                        $.bootstrapBox.alert.init({
                            message: result.message
                        });
                        $("#myTable").bootstrapTable("reload");
                    })*/

                }

            }
        });

    }
    function initTrader() {
        $("#traderid").bootstrapSelect({
            url: '/graindepot-base/selector/traderList',
            type: 'GET',
            valueField: 'traderid',
            textField: 'tradername',
            onSelect: function (traderid,row) {
                if(row){
                    param.traderid=traderid;
                }else{
                    delete param["traderid"];
                }
                query(param);
                comm_initContract(param);
            }
        })
    }
    function initStorage() {
        $("#storageid").bootstrapSelect({
            url: '/graindepot-base/selector/storageList',
            type: 'GET',
            valueField: 'storageid',
            textField: 'storagename',
            onSelect: function (storageid, row) {
                if (row) {
                    param.storageid=row.storageid;
                }else{
                    delete param["storageid"];
                }
                query(param);
            }
        });
    }
    function query(param) {
        if(theTable!=undefined) {
            theTable.destroy();
        }
        theTable = $('#myTable').bootstrapTable({
            //数据来源（包括处理分页，排序，过滤） ，即url，action，接口，等等
            ajax: {
                url: "/graindepot-inout/settlement/settmentPageList",
                data: param,
                type: "POST"
            },
            columns: [
                {title:"出库日期", data: "billdatestr"},
                {title:"出库流水号", data: "billcode"},
                {title:"车牌号", data: "trucknum"},
                {title: "仓房号", data: "storagename"},
                {title: "粮食性质", data: "grainattrname"},
                {title: "粮食品种", data: "grainname"},
                {title: "结算数量", data: "paidweight"},
                {title: "结算单价", data: "price"},
                {title: "结算金额", data: "amount"},
                {title: "摘要",data:"remark"}

            ]
        });

    }
</script>
</body>
</html>