<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head th:include="head::head(${title})">
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>智能粮库云平台</title>
</head>
<body>
<script th:src="@{/assets/js/bootstrap3-typeahead.js}"></script>
<script th:src="@{/graindepot-video/js/webVideoCtrl.js}"></script>
<script th:src="@{/graindepot-video/js/hik3.js}"></script>
<script th:src="@{/graindepot-inout/js/IC.js}"></script>
<script th:src="@{/graindepot-inout/js/ID.js}"></script>
<script th:inline="javascript">
    var ip = [[${video.ip}]],
        httpport = [[${video.httpport}]],
        username = [[${video.username}]],
        password = [[${video.password}]],
        channel = [[${video.channel}]],
        maliu = [[${video.maliu}]],
        datasignal = [[${video.datasignal}]];
    var bZeroChannel = false;//默认不用模拟信号
    var iStreamType = 1; //码流类型，1 主码流， 2 子码流
    // 初始化插件
    // 全局保存当前选中窗口
    var g_iWndIndex = 0; //可以不用设置这个变量，有窗口参数的接口中，不用传值，开发包会默认使用当前选择窗口
    $(function () {
        // 检查插件是否已经安装过
        if (-1 == WebVideoCtrl.I_CheckPluginInstall()) {
            //("您还未安装过插件，点击下载视频播放控件!");
            return;
        }
        var height = $("#divPlugin").height();
        var width = $("#divPlugin").width();
        // 初始化插件参数及插入插件
        WebVideoCtrl.I_InitPlugin(width, height, {
            iWndowType: 1,
            cbSelWnd: function (xmlDoc) {
                g_iWndIndex = $(xmlDoc).find("SelectWnd").eq(0).text();
                //var szInfo = "当前选择的窗口编号：" + g_iWndIndex;
                //showCBInfo(szInfo);
            }
        });
        WebVideoCtrl.I_InsertOBJECTPlugin("divPlugin");
        changeWndNum(1);
        if ("" != maliu) {
            iStreamType = maliu
        }
        if (datasignal == 2) {//模拟
            bZeroChannel = true;
        }
        clickLogin(ip, httpport, channel, bZeroChannel, username, password, iStreamType);
        clickStartRealPlay(ip, channel, bZeroChannel, iStreamType, 0);
    });

    function rePlay() {
        clickStartRealPlay(ip, channel, bZeroChannel, iStreamType, 0);
    }
</script>
<object classid="clsid:5EB842AE-5C49-4FD8-8CE9-77D4AF9FD4FF" id="IdrControl1" width="10" height="0" codebase="idr.cab">
</object>
<div class="main-container" id="main-container" style="margin-top: -29px;">
    <div class="main-container-inner">
        <div class="main-content" id="main-content" style="margin-left:0px;width:100%">
            <div class="page-content" style="padding:10px 30px 0px">
                <div class="row">
                    <div class="col-xs-12">
                        <!-- PAGE CONTENT BEGINS -->
                        <form class="form-horizontal" id="validation-form" role="form">
                            <div class="row">
                                <div class="col-xs-12 col-sm-4" style="border:1px solid #CCC;padding:3px;width:100%">
                                    <div style="width: 40%;height:100%;float: left">
                                        <div style="width: 100%;height:50%;text-align: center;">
                                            <div style="float:left;background-color: #E0FFFF;width: 70%;height:100%;text-align: center;">
                                                <label style="height:100%;line-height: 250px;font-size: 40px;">
                                                    <img id="photostr" src="" alt=""
                                                         style="width:150px;height:100%"/></label>
                                            </div>
                                            <div style="float:left;width: 30%;height:100%;text-align: center;padding-left:2px">
                                                <div style="width: 100%;">
                                                    <label>证件其他信息</label>
                                                    <div style="width:100%;border:solid 1px #CCC;text-align: left;padding:5px">
                                                        <div style="height:20px;">性别：<label id="gender">—&nbsp;—</label>
                                                        </div>
                                                        <div style="height:20px">民族：<label id="nation">—&nbsp;—</label>
                                                        </div>
                                                        <div style="height:20px">出生：<label id="bornday">—&nbsp;—</label>
                                                        </div>
                                                        <div style="height:20px">签发机关:</div>
                                                        <div style="height:20px"><label id="certorg">—&nbsp;—</label>
                                                        </div>
                                                        <div style="height:20px">开始期限:</div>
                                                        <div style="height:20px"><label id="effdate">—&nbsp;—</label>
                                                        </div>
                                                        <div style="height:20px">结束期限:</div>
                                                        <div style="height:20px"><label id="expdate">—&nbsp;—</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="width: 100%;height:50%;text-align: center;">

                                            <div style="float:left;width: 70%;height:100%;background-color: black;text-align: center;">
                                                <div id="divPlugin" style="width:100%;height:230px"></div>
                                                <div style="width:100%;height:20px;text-align: right;padding-right:10px">
                                                    <span id="msg" style="color:red"></span>
                                                    <a class="red" href="javascript:rePlay()" style="padding-left:5px;"
                                                       title="播放刷新">
                                                        <i class="icon-facetime-video bigger-130"></i>
                                                    </a>
                                                </div>
                                            </div>
                                            <div style="float:left;width: 30%;height:100%;text-align: center;padding-left:2px">
                                                <div style="width: 100%;">
                                                    <label>自动抓拍车牌列表</label>

                                                    <select class="form-control" id="active_trucknum"
                                                            multiple="multiple" style="height: 160px"
                                                            onchange="chooseTruckNum()">
                                                        <option value="AL">苏BA3G19</option>
                                                        <option value="AK">苏BH3433</option>
                                                        <option value="AZ">苏A23232</option>
                                                        <option value="AR">苏876822</option>
                                                        <option value="CA">苏C89333</option>
                                                        <option value="CO">苏897923</option>
                                                    </select>
                                                </div>
                                                <button class="btn btn-primary"
                                                        style="margin-top: 10px;width:90%">
                                                    <i class="icon-camera"></i>
                                                    车牌识别
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="width: 60%;height:100%;padding-left:10px;float: left">
                                        <div class="form-group">
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="billcode">
                                                登记流水号:
                                            </label>
                                            <div class="col-sm-5">
                                                <input type="text" name="billcode" id="billcode" class="form-control"
                                                       readonly placeholder=""/>
                                            </div>
                                            <label class="col-sm-1 control-label no-padding-right"
                                                   for="billstate">
                                                状态:
                                            </label>
                                            <div class="col-sm-2">
                                                <label id="billstate" style="margin-top: 4px;"
                                                       class="center red">未保存</label>
                                            </div>
                                        </div>
                                        <hr style="margin-bottom:5px;margin-top:5px"/>
                                        <div class="form-group">
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="printtempid">
                                                结算单模板:
                                            </label>
                                            <div class="col-sm-2">
                                                <select id="printtempid" name="printtempid" class="form-control">
                                                </select>
                                            </div>

                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="onetomany">
                                                检斤方式:
                                            </label>
                                            <div class="col-sm-2">
                                                <select id="onetomany" name="onetomany" class="form-control">
                                                </select>
                                            </div>
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="settlemothod">
                                                结算类型:
                                            </label>
                                            <div class="col-sm-2">
                                                <select id="settlemothod" name="settlemothod" class="form-control">
                                                </select>
                                            </div>
                                        </div>
                                        <hr style="margin-bottom:5px;margin-top:5px"/>
                                        <div class="form-group">
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="customtype1">
                                                客户性质:
                                            </label>
                                            <div class="col-sm-2" style="margin-top: 2px">
                                                <label>
                                                    <input name="customtype" type="radio"
                                                           value="1" id="customtype1"
                                                           class="ace form-control" onclick="chooseCustomtype(1)"/>
                                                    <span class="lbl"> 个人</span>
                                                </label>
                                                <label>
                                                    <input name="customtype" type="radio"
                                                           value="2" id="customtype2"
                                                           class="ace form-control" onclick="chooseCustomtype(2)"/>
                                                    <span class="lbl"> 单位</span>
                                                </label>
                                            </div>

                                            <label style="width: 12%" id="trader"
                                                   class="col-sm-1 control-label no-padding-right" for="traderid">
                                                售粮单位:
                                            </label>
                                            <div class="col-sm-4">
                                                <select id="traderid" name="traderid" class="form-control">
                                                </select>
                                            </div>
                                        </div>

                                        <hr style="margin-bottom:5px;margin-top:5px"/>
                                        <div class="form-group">
                                            <label style="width: 12%" id="manname"
                                                   class="col-sm-1 control-label no-padding-right"
                                                   for="sellmanname">
                                                *售粮人:
                                            </label>
                                            <div class="col-sm-2">
                                                <input type="text" id="sellmanname" name="sellmanname"
                                                       placeholder="" class="form-control"/>
                                            </div>
                                            <label style="width: 12% " id="idcard"
                                                   class="col-sm-1 control-label no-padding-right"
                                                   for="sellmanidcard">
                                                身份证号:
                                            </label>
                                            <div class="col-sm-3">
                                                <input type="text" id="sellmanidcard"
                                                       name="sellmanidcard"
                                                       placeholder="" class="form-control"/>
                                            </div>
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="sellmanphone">
                                                联系电话:
                                            </label>
                                            <div class="col-sm-2">
                                                <input type="text" id="sellmanphone" name="sellmanphone"
                                                       placeholder="" class="form-control"/>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="sellmanaddress">
                                                联系地址:
                                            </label>
                                            <div class="col-sm-5">
                                                <input type="text" id="sellmanaddress" name="sellmanaddress"
                                                       placeholder="" class="form-control"/>
                                            </div>
                                            <a class="btn btn-primary col-sm-2"
                                               style="margin-left:5px;border:0" onclick="readCert()">
                                                <i class="icon-credit-card"></i>
                                                售粮人身份证
                                            </a>
                                            <a class="btn btn-primary col-sm-2"
                                               style="margin-left:5px;border:0">
                                                <i class="icon-globe"></i>
                                                微信扫码
                                            </a>
                                        </div>
                                        <div class="form-group">
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="trucktype">
                                                车船类型:
                                            </label>
                                            <div class="col-sm-2">
                                                <select id="trucktype" name="trucktype" class="form-control">
                                                </select>
                                            </div>
                                            <label class="col-sm-1 control-label no-padding-right"
                                                   for="trucknum">
                                                车船号:
                                            </label>
                                            <div class="col-sm-2">
                                                <input type="text" id="trucknum" name="trucknum"
                                                       placeholder="" class="form-control"/>
                                            </div>

                                            <label class="col-sm-1 control-label no-padding-right"
                                                   for="carriercorp" style="display: none">
                                                承运单位:
                                            </label>
                                            <div class="col-sm-2" style="display: none">
                                                <input type="text" id="carriercorp" name="carriercorp"
                                                       placeholder="" class="form-control"/>
                                            </div>
                                        </div>
                                        <hr style="margin-bottom:5px;margin-top:5px"/>
                                        <div class="form-group">
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="carriername">
                                                承运人:
                                            </label>
                                            <div class="col-sm-2">
                                                <input type="text" id="carriername" name="carriername"
                                                       placeholder="" class="form-control"/>
                                            </div>

                                            <label style="width: 14%" class="col-sm-1 control-label no-padding-right"
                                                   for="carrieridcard">
                                                承运人身份证:
                                            </label>
                                            <div class="col-sm-2">
                                                <input type="text" id="carrieridcard" name="carrieridcard"
                                                       placeholder="" class="form-control"/>
                                            </div>

                                            <a class="btn btn-primary col-sm-2" onclick="readCarrierCert()"
                                               style="margin-left:5px;border:0">
                                                <i class="icon-credit-card"></i>
                                                承运人身份证
                                            </a>
                                            <a class="btn btn-primary col-sm-2"
                                               style="margin-left:5px;border:0">
                                                <i class="icon-globe"></i>
                                                微信扫码
                                            </a>
                                        </div>
                                        <hr style="margin-bottom:5px;margin-top:5px"/>
                                        <div class="form-group">
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="storageid">
                                                仓房:
                                            </label>
                                            <div class="col-sm-2">
                                                <select id="storageid" name="storageid" class="form-control">
                                                </select>
                                            </div>
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="grainid">
                                                *粮食品种:
                                            </label>
                                            <div class="col-sm-2">
                                                <select id="grainid" name="grainid" class="form-control">
                                                </select>
                                            </div>
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="inplanid">
                                                计划安排:
                                            </label>
                                            <div class="col-sm-2">
                                                <select id="inplanid" name="inplanid" class="form-control">
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="contractid">
                                                合同号:
                                            </label>
                                            <div class="col-sm-2">
                                                <select id="contractid" name="contractid" class="form-control">
                                                </select>
                                            </div>
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="grainattrid">
                                                粮食性质:
                                            </label>
                                            <div class="col-sm-2">
                                                <select id="grainattrid" name="grainattrid" class="form-control">
                                                </select>
                                            </div>
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="producingyear">
                                                收获年度:
                                            </label>
                                            <div class="col-sm-2">
                                                <input type="text" id="producingyear" name="producingyear"
                                                       class="form-control" placeholder=""/>
                                            </div>
                                        </div>
                                        <hr style="margin-bottom:5px;margin-top:5px"/>
                                        <div class="form-group">
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="packtype">
                                                包装方式:
                                            </label>
                                            <div class="col-sm-2">
                                                <select id="packtype" name="packtype" class="form-control">
                                                </select>
                                            </div>
                                            <label class="col-sm-1 control-label no-padding-right"
                                                   for="packcount">
                                                总包数:
                                            </label>
                                            <div class="col-sm-2">
                                                <input type="text" id="packcount" name="packcount"
                                                       class="form-control" placeholder=""/>
                                            </div>
                                            <label style="width: 14%;" class="col-sm-1 control-label no-padding-right"
                                                   for="selfreport">
                                                自报数量(千克):
                                            </label>
                                            <div class="col-sm-2">
                                                <input type="text" id="selfreport" name="selfreport"
                                                       class="form-control" placeholder=""/>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label style="width: 12%" class="col-sm-1 control-label no-padding-right"
                                                   for="fprovinceid">
                                                调入省份:
                                            </label>
                                            <div class="col-sm-2">
                                                <select id="fprovinceid" name="fprovinceid" class="form-control">
                                                </select>
                                            </div>
                                            <label class="col-sm-1 control-label no-padding-right"
                                                   for="fcityid">
                                                市(州):
                                            </label>
                                            <div class="col-sm-2">
                                                <select id="fcityid" name="fcityid" class="form-control">
                                                </select>
                                            </div>
                                            <label class="col-sm-1 control-label no-padding-right"
                                                   for="soucearea">
                                                原产地:
                                            </label>
                                            <div class="col-sm-2">
                                                <input type="text" id="soucearea" name="soucearea"
                                                       class="form-control" placeholder=""/>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <!--<div style="float: left;padding-left: 10px">
                                                <label class="col-sm-4 control-label no-padding-right" style="width:70px;padding-left:0px"> 入库原由：</label>
                                                <div class="col-sm-4" style="width:150px;padding-left:0px">
                                                    <select id="inresontype" name="inresontype" class="form-control">
                                                    </select>
                                                </div>
                                            </div>-->
                                            <label style="width: 12%;" class="col-sm-1 control-label no-padding-right"
                                                   for="remark">
                                                备注:
                                            </label>
                                            <div class="col-sm-5">
                                                <input type="text" id="remark" name="remark"
                                                       class="form-control" placeholder=""/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- /span -->
                            </div>
                            <div class="row" style="float: right;padding-right: 12px">
                                <!--<object id="CertCtl" type="application/cert-reader" width="0"
                                        height="0">
                                    <p style="color:#FF0000;">控件不可用，可能未正确安装控件及驱动，或者控件未启用。<a
                                            onclick="download_Huashi()"
                                            style="text-decoration: underline;color:blue;cursor:pointer;">下载</a>
                                    </p>
                                </object>-->
                                <a class="btn btn-success" style="border: 0;width: 120px;"
                                   onclick="toFindInoutDetail(1)">
                                    <i class="icon-arrow-left icon-on-left"></i>
                                    前一单
                                </a>
                                <a class="btn btn-success" style="border: 0;width: 120px;"
                                   onclick="toFindInoutDetail(3)">
                                    <i class="icon-arrow-right icon-on-right"></i>
                                    后一单
                                </a>
                                <OBJECT id=rd codeBase="comRD800.cab" WIDTH="10" HEIGHT="0"
                                        classid="clsid:638B238E-EB84-4933-B3C8-854B86140668">
                                </OBJECT>
                                <a class="btn btn-success" style="border: 0;width: 120px;"
                                   onclick="toFindInoutDetail(2)">
                                    <i class="icon-credit-card"></i>
                                    刷卡查单
                                </a>
                                <a class="btn btn-success" style="border: 0;width: 120px;"
                                   onclick="toInoutList()">
                                    <i class="icon-tint"></i>
                                    流水号查单
                                </a>
                                <a class="btn btn-success" style="border: 0;width: 120px;"
                                   onclick="toSave(2)" id="canSaveWrite">
                                    <i class="icon-save"></i>
                                    保存写卡
                                </a>
                                <a class="btn btn-success" style="border: 0;width: 120px;"
                                   onclick="toSave()" id="canSave">
                                    <i class="icon-save"></i>
                                    保存
                                </a>
                                <a class="btn btn-default" style="display: none;border: 0;width: 120px;"
                                   id="notSaveWrite">
                                    <i class="icon-save"></i>
                                    保存写卡
                                </a>
                                <a class="btn btn-default" style="display: none;border: 0;width: 120px;"
                                   id="notSave">
                                    <i class="icon-save"></i>
                                    保存
                                </a>
                                <a class="btn btn-success" style="border: 0;width: 120px;padding-left:10px"
                                   onclick="toAdd()">
                                    <i class="icon-plus-sign"></i>
                                    新增
                                </a>
                                <a class="btn btn-success" style="border: 0;width: 120px;padding-left:10px"
                                   onclick="reset()">
                                    <i class="icon-undo"></i>
                                    取消
                                </a>
                            </div>
                        </form>
                    </div>
                    <!-- /.col -->
                </div>
                <!-- /.row -->
            </div>
            <!-- /.page-content -->
        </div>
        <!-- /.main-content -->
    </div>
    <!-- /.main-container-inner -->
</div>
<script th:inline="javascript">
    //var urlPrefix = "";
    var urlPrefix = "/graindepot-inout";
    var g_userAddress = [[${userAddress}]];
    var IcObject = new IcFactory(1).createIcObject();
    var IdObject = new IdFactory(1).createIdObject();
    $(function ($) {
        //隐藏按钮
        initOnetomany();
        initSettlemothod();
        initPacktype();
        initTrucktype();
        //初始化仓房
        initStorage();
        initGrain();
        initTrader();
        initFprovince();
        comm_initGrainattr();
        //结算单模板

        //initPlanfileInput();
        //初始化计划安排
        //initPlanfileInplan();
        /*定时刷新自动抓拍的车牌*/
        //window.setInterval("RefreshTrucknum()",3000);
        //默认选择个人
        $("#customtype1").attr("checked", "checked");
        initPrinttemp();
        sellmannameAutoComplete();
    });

    //结算单
    function initPrinttemp() {
        $("#printtempid").bootstrapSelect({
            url: '/graindepot-inout/lodop/list/1005',
            type: 'GET',
            valueField: 'lodopid',
            textField: 'lodopname'
        })
    }

    function chooseTruckNum() {
        var trucknumText = $("#active_trucknum option:selected").text();
        var trucknumVal = $("#active_trucknum option:selected").val();
        $("#trucknum").val(trucknumText);

    }

    //flag=2 表示保存并写卡
    function toSave(flag) {
        //判断必填项
        if (!checkRequire()) return;
        var param = turnArrayToJson($('form').serializeArray());
        $.get("/graindepot-inout/inout/billid/byBillcode", {billcode: param.billcode})
            .then(function (result) {
                param.billid = result.data;
                param.sellmansex = getSexByText($("#gender").text());
                $.post("/graindepot-inout/register/editIn", param, function (result) {
                    if (result.success) {
                        //将保存成功的单据保存到cache中，便于新增或者取消时显示上次数据
                        setCookie("latestIn", JSON.stringify(result.data), 1);
                        $("#billcode").val(result.data.billcode);
                        if (flag == 2) {
                            //判断当前的卡能否进行绑定（粮库下无未退卡的单据跟其绑定）
                            var iccardnum = IcObject.readCardNum();
                            if (iccardnum == "ERROR") {
                                $("#billstate").html("已保存写卡失败");
                                return
                            }
                            var canWriteCard = dataJson("GET"
                                , "/graindepot-inout/register/canWriteCard", {iccardnum: iccardnum});
                            if (!canWriteCard.success) {
                                $.bootstrapBox.alert.init({message: "单据保存成功," + canWriteCard.message});
                                return
                            }
                            //可以写卡后继续操作
                            var writeSuccess = writeCard(result.data);
                            if (writeSuccess) {
                                //去更新绑卡字段和ic卡号
                                $.post("/graindepot-inout/register/inout/updateByMap", {
                                    Where_billid: result.data.billid,
                                    regstate: 1,
                                    iccardnum: iccardnum
                                }).then(function () {
                                    $("#billstate").html("已保存已写卡");
                                });
                            } else {
                                $("#billstate").html("已保存写卡失败");
                            }
                        } else {
                            $("#billstate").html("已保存未写卡");
                        }
                        //$.bootstrapBox.alert.init({message: result.message});
                        parent.changeTab(1,param.billcode);
                    } else {
                        $.bootstrapBox.alert.init({message: "保存失败"})
                    }
                });

            });
        //保存大户信息
        var individual = {
            name: param.sellmanname,
            idcard: param.sellmanidcard,
            address: param.sellmanaddress,
            gender: param.sellmansex,
            phone: param.sellmanphone,
            trucktype: param.trucktype,
            trucknum: param.trucknum,
            nation: $("#nation").html(),
            bornday: $("#bornday").html(),
            certorg: $("#certorg").html(),
            effdate: $("#effdate").html(),
            expdate: $("#expdate").html()
        };
        $.post("/graindepot-inout/register/addIndividual", individual)
    }

    function checkRequire() {
        var customtype = $("input[name='customtype']:checked").val();
        if (customtype == 1) {
            if (!$("#sellmanname").val()) {
                $.bootstrapBox.alert.init({message: "售粮人不能为空"});
                return false
            }
        }
        if (customtype == 2) {
            if (!$("#traderid").bootstrapSelect("getValue")) {
                $.bootstrapBox.alert.init({message: "售粮单位不能为空"});
                return false
            }
        }
        if (!$("#grainid").bootstrapSelect("getValue")) {
            $.bootstrapBox.alert.init({message: "粮食品种不能为空"});
            return false
        }
        return true

    }

    function getSexByText(text) {
        if (text == "男") {
            return 1;
        } else if (text == "女") {
            return 2;
        } else {
            return 3;
        }

    }

    //售粮人自动显示
    function sellmannameAutoComplete() {
        $("#sellmanname").typeahead({
            source: function (query, process) {
                return $.ajax({
                    url: '/graindepot-inout/register/individual/byName',
                    type: 'post',
                    data: {name: query},
                    success: function (result) {
                        //默认筛选name字段的值
                        return process(result);
                    }
                })
            },//数据源
            items: 8,//最多显示个数
            fitToElement: true,
            updater: function (item) {
                return item;//选中后获得的数据
            },
            afterSelect: function (item) {
                //选择项之后的事件 ，item是当前选中的。
                $("#sellmanidcard").val(item.idcard);
                $("#sellmanphone").val(item.phone);
                $("#sellmanaddress").val(item.address);
                setIndividualOtherInfo(item);
            },
            delay: 500//延迟时间
        });
    }

    function RefreshTrucknum() {
        $("#active_trucknum").append("<option value='CO'>苏897923</option>")
    }

    function initFprovince() {
        $("#fprovinceid").bootstrapSelect({
            url: '/graindepot-base/selector/provinceList',
            type: 'GET',
            valueField: 'provinceid',
            textField: 'provincename',
            defaultValue: g_userAddress.provinceid,
            onSelect: function (provinceid, row) {
                if (provinceid) {
                    initFcity(provinceid)
                } else {
                    $("#fcityid").bootstrapSelect("empty");
                }
            }
        });
    }

    function initFcity(provinceid) {
        $("#fcityid").bootstrapSelect({
            url: '/graindepot-base/selector/cityList',
            type: 'GET',
            valueField: 'cityid',
            textField: 'cityname',
            defaultValue: g_userAddress.cityid,
            param: {provinceid: provinceid}
        });

    }

    function initStorage() {
        $("#storageid").bootstrapSelect({
            url: '/graindepot-inout/selectorInout/storageByMap',
            type: 'GET',
            valueField: 'storageid',
            textField: 'storagename',
            onSelect: function (storageid, row) {
                if (storageid) {
                    $("#grainid").bootstrapSelect("setValue", row.defgrainid)
                }
            }
        });
    }

    function initGrain(defaultGrainid) {
        $("#grainid").bootstrapSelect({
            url: '/graindepot-base/selector/grainList',
            type: 'GET',
            valueField: 'grainid',
            textField: 'grainname',
            defaultValue: defaultGrainid,
            onSelect: function (grainid, row) {
                if (!grainid) {
                    $("#inplanid").bootstrapSelect("empty");
                    $("#contractid").bootstrapSelect("empty");
                } else {
                    initPlanfileInput(grainid);
                    initContract(grainid);
                }
            }
        });
    }

    function initPlanfileInput(grainid) {
        $("#inplanid").bootstrapSelect({
            url: '/graindepot-inout/selectorInout/planfileInplan/byGrainid',
            type: 'GET',
            valueField: 'plandetailid',
            textField: 'planname',
            param: {grainid: grainid}
        });
    }

    function initContract(grainid) {
        $("#contractid").bootstrapSelect({
            url: '/graindepot-inout/selectorInout/contractByMap',
            type: 'GET',
            valueField: 'contractid',
            textField: 'contractno',
            param: {grainid: grainid}
        });
    }

    function initTrader() {
        $("#traderid").bootstrapSelect({
            url: '/graindepot-base/selector/traderList',
            type: 'GET',
            valueField: 'traderid',
            textField: 'tradername',
            onSelect: function (traderid, row) {
                if (row) {
                    $("#sellmanphone").val(row.telnumber);
                    $("#sellmanaddress").val(row.traderaddress);
                }
            }
        })
    }

    //检斤方式
    function initOnetomany() {
        var data = [{value: 1, text: "一单一车"}, {value: 2, text: "一单多车"}];
        $("#onetomany").bootstrapSelect({
            data: data,
            valueField: 'value',
            textField: 'text',
            defaultValue: 1
        });
    }

    function initSettlemothod() {
        var data = [{value: 1, text: "现金结算"}, {value: 2, text: "银行卡结算"}, {value: 3, text: "微信结算"}, {
            value: 4,
            text: "支付宝结算"
        }];
        $("#settlemothod").bootstrapSelect({
            data: data,
            valueField: 'value',
            textField: 'text',
            defaultValue: 1
        });
    }

    function initPacktype() {
        var data = [{value: 1, text: "散装"}, {value: 2, text: "包装"}];
        $("#packtype").bootstrapSelect({
            data: data,
            valueField: 'value',
            textField: 'text',
            defaultValue: 1
        });
    }

    function initInresontype() {
        var data = [{value: 1, text: "轮入"}, {value: 2, text: "其他收入"}];
        $("#inresontype").bootstrapSelect({
            data: data,
            valueField: 'value',
            textField: 'text',
            defaultValue: 1
        });
    }

    function initTrucktype() {
        var data = [{value: 1, text: "车辆"}, {value: 2, text: "船舶"}, {value: 3, text: "火车"}, {value: 99, text: "其他"}];
        $("#trucktype").bootstrapSelect({
            data: data,
            valueField: 'value',
            textField: 'text',
            defaultValue: 1
        });
    }

    function chooseCustomtype(type) {
        //清空 身份证 联系电话  售粮人  联系地址信息
        $("#sellmanidcard").val("");
        $("#sellmanname").val("");
        $("#sellmanphone").val("");
        $("#sellmanaddress").val("");
        if (type == 1) {
            //身份证变为必填
            $("#manname").html("*售粮人:");
            $("#trader").html("售粮单位:");
            /*$("#validation-form").bootstrapValidator("addField", "sellmanidcard", {
                validators: {
                    notEmpty: {}
                }
            });
            //售粮人变为必填
            $("#validation-form").bootstrapValidator("addField", "sellmanname", {
                validators: {
                    notEmpty: {}
                }
            });
            //售粮单位不是必填项
            $("#validation-form").bootstrapValidator('removeField', 'traderid');*/
        } else {
            $("#manname").html("售粮人:");
            $("#trader").html("*售粮单位:");
            /* //让身份证栏不是必填项
             $("#validation-form").bootstrapValidator('removeField', 'sellmanidcard');
             //清空售粮人不是必填项
             $("#validation-form").bootstrapValidator('removeField', 'sellmanname');
             //售粮单位变为必填
             $("#validation-form").bootstrapValidator("addField", "traderid", {
                 validators: {
                     notEmpty: {}
                 }
             });*/

        }
    }

    //新增
    function toAdd() {
        clearForm();
        $("input").val("");
        $("#validation-form").find("select").each(function (index, curr) {
            $(this).bootstrapSelect("reload")
        });
        $("#billstate").html("未保存");
        $("#customtype1").attr("checked", "checked");
        $("#customtype2").attr("checked", false);
        //设置保存按钮显示
        $("#canSave").show();
        $("#canSaveWrite").show();
        $("#notSave").hide();
        $("#notSaveWrite").hide();
        //触发change事件
        $("select").trigger("change");
        setDefaultInfo();
    }

    //根据查出的入库信息初始化页面显示
    function setInout(inout) {
        $("#printtempid").bootstrapSelect("setValue", inout.printtempid);
        $("#onetomany").bootstrapSelect("setValue", inout.onetomany);
        $("#settlemothod").bootstrapSelect("setValue", inout.settlemothod);
        if (inout.customtype == 1) {
            $("#customtype1").attr("checked", "checked");
            $("#customtype2").removeAttr("checked");
        } else {
            $("#customtype1").removeAttr("checked");
            $("#customtype2").attr("checked", "checked");
        }
        $("#traderid").bootstrapSelect("setValue", inout.traderid);
        $("#sellmanidcard").val(inout.sellmanidcard);
        $("#sellmanphone").val(inout.sellmanphone);
        $("#sellmanname").val(inout.sellmanname);
        $("#sellmanaddress").val(inout.sellmanaddress);
        $("#trucktype").bootstrapSelect("setValue", inout.trucktype);
        $("#trucknum").val(inout.trucknum);
        $("#carriername").val(inout.carriername);
        $("#carrieridcard").val(inout.carrieridcard);
        $("#storageid").bootstrapSelect("setValue", inout.storageid);
        $("#grainid").bootstrapSelect("setValue", inout.grainid);
        $("#inplanid").bootstrapSelect("setValue", inout.inplanid);
        $("#producingyear").val(inout.producingyear);
        $("#contractid").bootstrapSelect("setValue", inout.contractid);
        $("#packtype").bootstrapSelect("setValue", inout.packtype);
        $("#packcount").val(inout.packcount);
        $("#selfreport").val(inout.selfreport);
        $("#fprovinceid").bootstrapSelect("setValue", inout.fprovinceid);
        $("#fcityid").bootstrapSelect("setValue", inout.fcityid);
        $("#soucearea").val(inout.soucearea);
        $("#remark").val(inout.remark);
        $("#billcode").val(inout.billcode);
        if (inout.regstate == 1) {
            $("#billstate").html("已保存已写卡");
        } else if (inout.regstate == 0) {
            $("#billstate").html("已保存未写卡");
        } else if (inout.regstate == -1) {
            $("#billstate").html("已保存已退港");
        }
        if (inout.stopflag == 1) {
            $("#billstate").html("已终止");
            $("#canSave").hide();
            $("#canSaveWrite").hide();
            $("#notSave").show();
            $("#notSaveWrite").show();
        } else {
            $("#canSave").show();
            $("#canSaveWrite").show();
            $("#notSave").hide();
            $("#notSaveWrite").hide();
        }
        //清除证件其他信息
        clearIndividualOtherInfo();
    }

    //type 1:前一单 2:刷卡查单  3:后一单
    function toFindInoutDetail(flag) {
        var billcode;
        if (flag == 2) {
            //billcode = d8ReadCard(1);
            billcode = IcObject.readCard(1);
            if (billcode == "ERROR") {
                return
            } else {
                if (!billcode) {
                    $.bootstrapBox.alert.init({message: "ic卡内无流水号数据"})
                    return
                }
            }
        } else {
            billcode = $("#billcode").val();
        }
        //根据billcode获取billid
        $.get("/graindepot-inout/inout/billid/byBillcode", {billcode: billcode})
            .then(function (result) {
                doFindInout(result.data, flag);
            });

    }

    function doFindInout(billid, flag) {
        $.get("/graindepot-inout/inout/findOneIn", {billid: billid, flag: flag})
            .then(function (result) {
                if (result.success) {
                    var inout = result.data;
                    setInout(inout);
                } else {
                    $.bootstrapBox.alert.init({message: result.message})
                }
            }, function () {
                $.bootstrapBox.alert.init({message: "查询失败"})
            })
    }

    //流水号查单
    function toInoutList() {
        $.bootstrapBox.dialog.init({
            title: "入库单据列表",
            url: urlPrefix + "/inout/toDialogInout?inoutflag=1&type=1",
            width: $(window).width() * 1,
            height: $(window).height() * 0.8
        })
    }

    //写卡
    function writeCard(inout) {
        var data = [
            {position: 1, data: inout.billcode},
            {position: 2, data: inout.sellmanname},
            {position: 4, data: inout.trucknum}
        ];
        if (inout.sellmanidcard && inout.sellmanidcard.length > 16) {
            data.push({position: 5, data: inout.sellmanidcard.substr(0, 16)});
            data.push({position: 6, data: inout.sellmanidcard.substr(16)})
        } else {
            data.push({position: 5, data: inout.sellmanidcard});
        }
        //  var rd = document.getElementById("rd");
        // return d8WriteCard(data, rd);
        return IcObject.writeCard(data);
    }

    //取消按钮
    function reset() {
        //根据billcode获取billid
        var billcode = $("#billcode").val();
        $.get("/graindepot-inout/inout/billid/byBillcode", {billcode: billcode})
            .then(function (result) {
                doFindInout(result.data, 2);
            });
        //toAdd();
        /*$(".form-group").find("input").each(function () {
            $(this).val(undefined)
        });
        $(".form-group").find("select").each(function () {
            $(this).bootstrapSelect("reload")
        })*/
    }

    //填充证件其他信息
    function setIndividualOtherInfo(individual) {
        $("#gender").html(individual.genderstr);
        $("#nation").html(individual.nation);
        $("#bornday").html(individual.bornday);
        $("#certorg").html(individual.certorg);
        $("#effdate").html(individual.effdate);
        $("#expdate").html(individual.expdate);
    }

    //清除证件其他信
    function clearIndividualOtherInfo(individual) {
        $("#gender").html("");
        $("#nation").html("");
        $("#bornday").html("");
        $("#certorg").html("");
        $("#effdate").html("");
        $("#expdate").html("");
    }

    //点击新增或者取消时填充上条记录的信息到表中
    function setDefaultInfo() {
        var inoutStr = getCookie("latestIn");
        var inout = JSON.parse(inoutStr);
        $("#printtempid").bootstrapSelect("setValue", inout.printtempid);
        $("#storageid").bootstrapSelect("setValue", inout.storageid);
        $("#grainid").bootstrapSelect("setValue", inout.grainid);
        $("#inplanid").bootstrapSelect("setValue", inout.inplanid);
        $("#contractid").bootstrapSelect("setValue", inout.contractid);
        $("#grainattrid").bootstrapSelect("setValue", inout.grainattrid);
        $("#producingyear").val(inout.producingyear);
        $("#soucearea").val(inout.soucearea);
    }

    function readCert() {
        var info = IdObject.readIdCard();
        if (info) {
            $("#sellmanname").val(info.name);
            $("#sellmanaddress").val(info.address);
            $("#sellmanidcard").val(info.idnumber);
            $("#gender").text(info.sex);
            $("#nation").text(info.nation);
            $("#bornday").text(info.birthday);
            $("#certorg").text(info.agency);
            $("#effdate").text(info.valid.split("-")[0]);
            $("#expdate").text(info.valid.split("-")[1]);
            $("#photostr").attr("src", "data:image/jpeg;base64," + info.picBase64);
        }
    }

    function readCarrierCert() {
        var info = IdObject.readIdCard();
        if (info) {
            $("#carriername").val(info.name);
            $("#carrieridcard").val(info.idnumber);
        }
    }

</script>
</body>
</html>